<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCI ADMIN</title>
    <link rel="icon" type="image/webp" href="assets/images/akaoci-small.webp">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">

    <style>
        /* Admin-Specific Overrides using Design System Tokens */
        .admin-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: var(--space-12);
            min-height: 80vh;
            padding-bottom: var(--space-20);
        }

        .admin-sidebar {
            position: sticky;
            top: 120px;
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .admin-nav-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-full);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all var(--duration-fast);
        }

        .admin-nav-item:hover {
            color: var(--color-text);
            background: rgba(255, 255, 255, 0.05);
        }

        .admin-nav-item.active {
            background: var(--color-text);
            color: var(--color-bg);
            font-weight: var(--font-medium);
        }

        .admin-main {
            padding-top: var(--space-1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-8);
            border-bottom: 1px solid var(--color-border);
        }

        .admin-title {
            font-size: var(--text-2xl);
            text-transform: uppercase;
            font-weight: var(--font-medium);
            letter-spacing: -0.02em;
        }

        /* List Items */
        .admin-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .admin-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-card-bg);
            /* #1A1A1A */
            border: 1px solid var(--color-border);
            padding: var(--space-4);
            transition: border-color var(--duration-fast);
        }

        .admin-card:hover {
            border-color: var(--color-text-muted);
        }

        .card-info {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }

        .card-thumb {
            width: 80px;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: var(--color-placeholder);
        }

        /* Service cards might want different aspect ratio, but 16/9 is safe for thumb */

        .card-text h3 {
            font-size: var(--text-base);
            margin-bottom: var(--space-1);
            color: var(--color-text);
        }

        .card-text p {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            margin: 0;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            place-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.is-visible {
            display: grid;
            opacity: 1;
        }

        .modal-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            width: 90%;
            max-width: 500px;
            /* padding: var(--space-8); REMOVED - padding loops inside specific sections */
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            /* Max height for the whole modal */
        }

        .modal-header {
            padding: var(--space-8) var(--space-8) var(--space-4) var(--space-8);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .modal-body {
            padding: var(--space-6) var(--space-8);
            overflow-y: auto;
            flex: 1;
            /* Takes remaining space */
        }

        .modal-footer {
            padding: var(--space-4) var(--space-8) var(--space-8) var(--space-8);
            border-top: 1px solid var(--color-border);
            flex-shrink: 0;
            background: var(--color-bg);
            /* Ensure opaque background */
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-8);
        }

        .modal-title {
            font-size: var(--text-xl);
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
        }

        .input,
        .textarea {
            width: 100%;
            background: var(--color-card-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: var(--text-sm);
            transition: border-color 0.2s;
        }

        .input:focus,
        .textarea:focus {
            outline: none;
            border-color: var(--color-text);
        }

        .textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Utility */
        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @media (max-width: 768px) {
            .admin-layout {
                grid-template-columns: 1fr;
                gap: var(--space-8);
                padding-bottom: var(--space-12);
            }

            .admin-sidebar {
                position: relative;
                /* Not sticky anymore */
                top: auto;
                z-index: 1;
                background: var(--color-bg);
                display: flex;
                flex-direction: row;
                gap: var(--space-4);
                padding: var(--space-4) 0;
                border-bottom: 1px solid var(--color-border);
            }

            /* Hide the separate Exit container on mobile */
            .admin-sidebar>div {
                display: none;
            }

            .admin-nav-item {
                flex: 1;
                /* Equal width tabs */
                text-align: center;
                white-space: nowrap;
                padding: var(--space-3) var(--space-2);
                background: var(--color-card-bg);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-sm);
                justify-content: center;
            }

            .admin-nav-item.active {
                background: var(--color-text);
                color: var(--color-bg);
                border-color: var(--color-text);
            }

            .admin-header {
                flex-direction: column;
                /* Stack on mobile */
                align-items: stretch;
                /* Full width button */
                gap: var(--space-4);
                margin-bottom: var(--space-6);
                padding-bottom: var(--space-4);
            }

            .admin-title {
                font-size: var(--text-lg);
            }

            .card-info {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-4);
                width: 100%;
            }

            .card-thumb {
                width: 100%;
                height: 180px;
                border-radius: var(--radius-sm);
            }

            .admin-card {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-4);
            }

            .card-text {
                width: 100%;
            }

            .card-text p {
                white-space: normal;
                /* Allow text wrapping on mobile */
                max-width: 100%;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .card-actions {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: var(--space-3);
                border-top: 1px solid var(--color-border);
                padding-top: var(--space-4);
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            /* Modal Mobile */
            .modal {
                align-items: flex-end;
                /* Bottom sheet style on mobile */
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                padding: 0;
                /* Let children handle padding */
                max-height: 90vh;
                border-bottom: none;
                /* Inherits display: flex from desktop rule */
            }
        }
    </style>
</head>

<body class="is-loaded">

    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <!-- Logo -->
                <a href="/admin" class="nav__logo">Admin Panel</a>

                <!-- Desktop Menu -->
                <div class="nav__links">
                    <a href="/" class="nav__link" target="_blank">View Site â†—</a>
                </div>

                <!-- Mobile Exit (Icon or Text) -->
                <a href="/" class="nav__link hide-desktop"
                    style="font-size: 12px; border: 1px solid var(--color-border); padding: 4px 10px; border-radius: 20px;">EXIT</a>
            </nav>
        </div>
    </header>

    <main class="page-transition">
        <section class="section" style="padding-top: 150px;">
            <div class="container">
                <div class="admin-layout">

                    <!-- Sidebar -->
                    <aside class="admin-sidebar">
                        <button class="admin-nav-item active" onclick="showTab('works')">Selected Works</button>
                        <button class="admin-nav-item" onclick="showTab('services')">Services</button>
                        <div
                            style="margin-top: auto; padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                            <button class="admin-nav-item" onclick="window.location.href='/'"
                                style="color: #ff4444;">Exit Admin</button>
                        </div>
                    </aside>

                    <!-- Main Content -->
                    <div class="admin-main">

                        <!-- Works Tab -->
                        <div id="tab-works" class="fade-in">
                            <header class="admin-header">
                                <h1 class="admin-title">Projects</h1>
                                <button class="btn btn--primary" onclick="openModal('work')">Add Project</button>
                            </header>

                            <div id="works-list" class="admin-list">
                                <!-- Loading State -->
                                <div
                                    style="padding: var(--space-8); text-align: center; color: var(--color-text-muted);">
                                    Connecting to Supabase...
                                </div>
                            </div>
                        </div>

                        <!-- Services Tab -->
                        <div id="tab-services" class="hidden fade-in">
                            <header class="admin-header">
                                <h1 class="admin-title">Services</h1>
                                <button class="btn btn--primary" onclick="openModal('service')">Add Service</button>
                            </header>

                            <div id="services-list" class="admin-list">
                                <!-- Loading State -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal (Shared Structure) -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Header (Fixed) -->
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Edit Item</h2>
                <button class="nav__menu-btn" onclick="closeModal()"
                    style="display:block; position:static;">CLOSE</button>
            </div>

            <!-- Body (Scrollable) -->
            <div class="modal-body">
                <form id="modal-form">
                    <input type="hidden" id="item-id">
                    <input type="hidden" id="item-type">

                    <div class="form-group">
                        <label class="label">Project Title</label>
                        <input type="text" id="input-title" class="input" required placeholder="Project Title">
                    </div>

                    <div class="form-group">
                        <label class="label" id="label-desc">Category</label>
                        <input type="text" id="input-desc" class="input" required placeholder="Web Development">
                    </div>

                    <!-- New Project URL Field -->
                    <div class="form-group" id="group-url">
                        <label class="label">Project URL (Link)</label>
                        <input type="text" id="input-url" class="input" placeholder="https://example.com">
                    </div>

                    <div class="form-group">
                        <label class="label">Project Image</label>

                        <!-- Preview Container -->
                        <div id="image-preview-container" style="margin-bottom: 10px; display: none;">
                            <img id="image-preview" src=""
                                style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 4px; border: 1px solid var(--color-border);">
                            <p style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Current Image
                            </p>
                        </div>

                        <input type="file" id="input-file" class="input" accept="image/*">
                        <input type="hidden" id="existing-image-url">
                        <small
                            style="color: var(--color-text-muted); font-size: 10px; margin-top: 5px; display:block;">Upload
                            a new image to replace.</small>
                    </div>
                </form>
            </div>

            <!-- Footer (Fixed) -->
            <div class="modal-footer">
                <button type="submit" form="modal-form" class="btn btn--primary" id="btn-save" style="width: 100%;">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        const sb = getSupabase();
        let worksData = [];
        let servicesData = [];

        // Tab Switching
        function showTab(tab) {
            // Update buttons
            document.querySelectorAll('.admin-nav-item').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show section
            document.getElementById('tab-works').classList.add('hidden');
            document.getElementById('tab-services').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        // Fetch Data
        async function loadData() {
            // Works
            const { data: works } = await sb.from('works').select('*').order('id');
            worksData = works || [];
            renderWorks();

            // Services
            const { data: services } = await sb.from('services').select('*').order('id');
            servicesData = services || [];
            renderServices();
        }

        function renderWorks() {
            const container = document.getElementById('works-list');
            if (worksData.length === 0) {
                container.innerHTML = '<p style="color:var(--color-text-muted)">No projects found.</p>';
                return;
            }
            container.innerHTML = worksData.map(item => `
                <div class="admin-card">
                    <div class="card-info">
                        <img src="${item.image_url}" class="card-thumb" onerror="this.style.background='red'">
                        <div class="card-text">
                            <h3>${item.title}</h3>
                            <p>${item.category}</p>
                            <a href="${item.project_url || '#'}" target="_blank" style="font-size: 10px; color: var(--color-text-muted);">${item.project_url ? 'Link Set' : 'No Link'}</a>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn--outline" style="padding: 8px 16px; font-size: 12px;" onclick="openModal('work', ${item.id})">EDIT</button>
                        <button class="btn btn--outline" style="padding: 8px 16px; font-size: 12px; border-color: #ff4444; color: #ff4444;" onclick="deleteItem('works', ${item.id})">DELETE</button>
                    </div>
                </div>
            `).join('');
        }

        function renderServices() {
            const container = document.getElementById('services-list');
            if (servicesData.length === 0) {
                container.innerHTML = '<p style="color:var(--color-text-muted)">No services found.</p>';
                return;
            }
            container.innerHTML = servicesData.map(item => `
                <div class="admin-card">
                    <div class="card-info">
                        <img src="${item.image_url}" class="card-thumb">
                        <div class="card-text">
                            <h3>${item.title}</h3>
                            <p>${item.description}</p>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn--outline" style="padding: 8px 16px; font-size: 12px;" onclick="openModal('service', ${item.id})">EDIT</button>
                        <button class="btn btn--outline" style="padding: 8px 16px; font-size: 12px; border-color: #ff4444; color: #ff4444;" onclick="deleteItem('services', ${item.id})">DELETE</button>
                    </div>
                </div>
            `).join('');
        }

        // Modal Logic
        function openModal(type, id = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('modal-form');
            const title = document.getElementById('modal-title');
            const fileInput = document.getElementById('input-file');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            document.getElementById('item-type').value = type;
            document.getElementById('item-id').value = id || '';

            // Reset File Input
            fileInput.value = '';

            // Labels & Visibility
            const labelDesc = document.getElementById('label-desc');
            const groupUrl = document.getElementById('group-url');

            labelDesc.innerText = type === 'work' ? 'CATEGORY' : 'DESCRIPTION';

            // Show/Hide URL field (Only for Works)
            if (type === 'work') {
                groupUrl.style.display = 'block';
            } else {
                groupUrl.style.display = 'none';
            }

            if (id) {
                // Edit Mode
                title.innerText = `EDIT ${type.toUpperCase()}`;
                const data = type === 'work'
                    ? worksData.find(w => w.id === id)
                    : servicesData.find(s => s.id === id);

                document.getElementById('input-title').value = data.title;
                document.getElementById('input-desc').value = type === 'work' ? data.category : data.description;
                document.getElementById('existing-image-url').value = data.image_url;

                if (data.image_url) {
                    previewImage.src = data.image_url;
                    previewContainer.style.display = 'block';
                } else {
                    previewContainer.style.display = 'none';
                }

                if (type === 'work') {
                    document.getElementById('input-url').value = data.project_url || '';
                }
            } else {
                // Add Mode
                title.innerText = `ADD ${type.toUpperCase()}`;
                form.reset();
                document.getElementById('item-type').value = type;
                previewContainer.style.display = 'none';
                document.getElementById('existing-image-url').value = '';
            }

            modal.classList.add('is-visible');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('is-visible');
        }

        // Upload Helper
        async function uploadImage(file) {
            const fileName = `public/${Date.now()}-${file.name.replace(/\s/g, '-')}`;
            const { data, error } = await sb.storage
                .from('portfolio')
                .upload(fileName, file, { cacheControl: '3600', upsert: false });

            if (error) throw error;

            const { data: publicData } = sb.storage
                .from('portfolio')
                .getPublicUrl(fileName);

            return publicData.publicUrl;
        }

        // Form Submit
        document.getElementById('modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerText;
            btn.innerText = 'UPLOADING...';
            btn.disabled = true;

            try {
                const type = document.getElementById('item-type').value;
                const id = document.getElementById('item-id').value;
                const table = type === 'work' ? 'works' : 'services';
                const fileInput = document.getElementById('input-file');
                let imageUrl = document.getElementById('existing-image-url').value;

                // Handle Image Upload
                if (fileInput.files.length > 0) {
                    imageUrl = await uploadImage(fileInput.files[0]);
                } else if (!imageUrl && !id) {
                    // New item without image
                    imageUrl = 'assets/images/project-1.jpg'; // placeholder
                }

                const payload = {
                    title: document.getElementById('input-title').value,
                    image_url: imageUrl
                };

                if (type === 'work') {
                    payload.category = document.getElementById('input-desc').value;
                    payload.project_url = document.getElementById('input-url').value;
                } else {
                    payload.description = document.getElementById('input-desc').value;
                }

                let error;
                if (id) {
                    ({ error } = await sb.from(table).update(payload).eq('id', id));
                } else {
                    ({ error } = await sb.from(table).insert([payload]));
                }

                if (error) {
                    alert('Database Error: ' + error.message);
                } else {
                    closeModal();
                    loadData();
                }

            } catch (err) {
                alert('Upload Error: ' + err.message + '\n\nMake sure "portfolio" bucket exists and is public!');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // Delete
        async function deleteItem(table, id) {
            if (!confirm('Delete this item?')) return;
            const { error } = await sb.from(table).delete().eq('id', id);
            if (error) alert(error.message);
            else loadData();
        }

        // Init
        loadData();

    </script>
</body>

</html>